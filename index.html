<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Lift Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">

</head>
<body>
    <div class="container">
        <header>
            <h1>LIFT TRACKER</h1>
            <div class="subtitle">Easily Record Your Lifts</div>
        </header>

        <!-- Home Screen -->
        <div id="homeScreen">
            <div class="section">
                <div class="section-title">Start Training</div>
                <button class="btn" id="startWorkoutBtn">Start Workout</button>
                <button class="btn btn-secondary" id="viewHistoryBtn">View History</button>
                <div class="helper-text" id="planHint">No plan yet? Browse ready-made plans or import a template.</div>
            </div>

            <div class="section">
                <div class="section-title">Get Started</div>
                <div class="helper-text">
                    Choose a plan to get moving fast, or import your own.
                </div>
                <button class="btn btn-secondary" id="showProgramsBtn">Browse Ready-Made Plans</button>
                <button class="btn btn-secondary" id="showImportBtn">Import Plan</button>
                <a class="template-link" href="Workout_Plan_Template.csv" download>Download Example Template</a>
            </div>

            <div class="section section-compact">
                <div class="section-title">Recent Stats</div>
                <div class="stats-grid stats-compact">
                    <div class="stat-card">
                        <div class="stat-value" id="totalWorkouts">0</div>
                        <div class="stat-label">Workouts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="thisWeek">0</div>
                        <div class="stat-label">This Week</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="thisMonth">0</div>
                        <div class="stat-label">This Month</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workout Selection Screen -->
        <div id="workoutSelectScreen" class="hidden">
            <button class="back-btn" id="workoutSelectBackBtn">‚Üê Back</button>
            <div class="section">
                <div class="section-title">Select Workout</div>
                <div id="workoutDaysList"></div>
            </div>
        </div>

        <!-- Programs Screen -->
        <div id="programsScreen" class="hidden">
            <button class="back-btn" id="programsBackBtn">‚Üê Back</button>
            <div class="section">
                <div class="section-title">Programs</div>
                <div id="programsList"></div>
            </div>
        </div>

        <!-- Active Workout Screen -->
        <div id="activeWorkoutScreen" class="hidden">
            <button class="back-btn" id="activeWorkoutBackBtn">‚Üê Back</button>
            <div class="section">
                <div class="section-title" id="currentWorkoutTitle"></div>
                <div id="exercisesList"></div>
                <button class="btn complete-workout-btn" id="completeWorkoutBtn">Complete Workout</button>
            </div>

            <div class="section">
                <div class="section-title">Rest Timer</div>
                <div style="color: var(--text-secondary); font-size: 0.85rem;">
                    Use the timer below each exercise.
                </div>
            </div>
        </div>

        <!-- Import Screen -->
        <div id="importScreen" class="hidden">
            <button class="back-btn" id="importBackBtn">‚Üê Back</button>
            <div class="section">
                <div class="section-title">Import Workout Plan</div>
                <label for="fileInput" class="file-label">
                    <div style="font-size: 2rem; margin-bottom: 10px;">üìÅ</div>
                    <div>Tap to select Excel file</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">.xlsx or .csv</div>
                </label>
                <input type="file" id="fileInput" accept=".xlsx,.csv">
                <a class="template-link" href="Workout_Plan_Template.csv" download>Download Template CSV</a>
            </div>
        </div>

        <!-- History Screen -->
        <div id="historyScreen" class="hidden">
            <button class="back-btn" id="historyBackBtn">‚Üê Back</button>
            <div class="section">
                <div class="section-title">Workout History</div>
                <div id="historyList"></div>
            </div>
        </div>

        <!-- Confirm Program Modal -->
        <div id="programModal" class="modal hidden">
            <div class="modal-content">
                <div class="section-title" id="programModalTitle">Load Program</div>
                <div class="modal-text" id="programModalBody"></div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="cancelProgramBtn">Cancel</button>
                    <button class="btn" id="confirmProgramBtn">Replace Plan</button>
                </div>
            </div>
        </div>

        <div id="exerciseDemoModal" class="modal hidden">
            <div class="modal-content demo-modal-content">
                <div class="section-title" id="exerciseDemoTitle">Exercise Demo</div>
                <div id="exerciseDemoBody" class="modal-text demo-modal-body"></div>
                <div class="modal-actions">
                    <a class="btn btn-secondary hidden" id="exerciseDemoSourceLink" target="_blank" rel="noopener noreferrer">Open Source</a>
                    <button class="btn" id="closeExerciseDemoBtn">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // State management
        let workoutPlan = null;
        let workoutHistory = [];
        let currentWorkout = null;
        let timerIntervals = [];
        let timerSeconds = [];
        let timerRunning = [];
        let builtInPrograms = [];
        let selectedProgram = null;
        let selectedExerciseDemo = null;
        let timerEndAt = [];
        let audioContext = null;
        let inactivityTimeout = null;
        const INACTIVITY_COMPLETE_MS = 25 * 60 * 1000;
        const PROGRAMS_CSV = `Program,Day,Type,Exercise,Sets,Reps,Rest,Notes,Suggested Weight
StrongLifts 5x5,Monday,Workout A,Barbell Squat,5,5,180,Add 5lbs each session,45
StrongLifts 5x5,Monday,Workout A,Barbell Bench Press,5,5,180,Keep heels on floor,45
StrongLifts 5x5,Monday,Workout A,Barbell Row,5,5,180,Pull to lower chest,45
StrongLifts 5x5,Wednesday,Workout B,Barbell Squat,5,5,180,Add 5lbs each session,50
StrongLifts 5x5,Wednesday,Workout B,Overhead Press,5,5,180,Strict form; no leg drive,45
StrongLifts 5x5,Wednesday,Workout B,Deadlift,1,5,180,Add 10lbs each session,95
StrongLifts 5x5,Friday,Workout A,Barbell Squat,5,5,180,Add 5lbs each session,55
StrongLifts 5x5,Friday,Workout A,Barbell Bench Press,5,5,180,,50
StrongLifts 5x5,Friday,Workout A,Barbell Row,5,5,180,,50
3-Day Full Body,Monday,Full Body,Goblet Squats,3,10-12,90,Focus on depth,25
3-Day Full Body,Monday,Full Body,Push-ups,3,AMRAP,60,As many reps as possible,
3-Day Full Body,Monday,Full Body,Dumbbell Rows,3,10-12,60,,20
3-Day Full Body,Wednesday,Full Body,Dumbbell Lunges,3,10,90,Reps per leg,15
3-Day Full Body,Wednesday,Full Body,Dumbbell Shoulder Press,3,10-12,60,,20
3-Day Full Body,Wednesday,Full Body,Lat Pulldowns,3,10-12,90,,70
3-Day Full Body,Friday,Full Body,Romanian Deadlifts,3,12,90,Keep back flat,45
3-Day Full Body,Friday,Full Body,Dumbbell Bench Press,3,10-12,90,,30
3-Day Full Body,Friday,Full Body,Plank,3,45s,60,Focus on core tension,
Upper/Lower Split,Monday,Upper Split,Bench Press,3,8-10,120,,95
Upper/Lower Split,Monday,Upper Split,Seated Cable Row,3,10-12,90,,80
Upper/Lower Split,Monday,Upper Split,Dumbbell Lateral Raise,3,12-15,60,,10
Upper/Lower Split,Tuesday,Lower Split,Back Squat,3,8-10,120,,135
Upper/Lower Split,Tuesday,Lower Split,Leg Curls,3,12-15,90,,60
Upper/Lower Split,Tuesday,Lower Split,Calf Raises,4,15,60,,
Upper/Lower Split,Thursday,Upper Split,Overhead Press,3,8-10,120,,65
Upper/Lower Split,Thursday,Upper Split,Pull Ups,3,6-10,120,Assisted if needed,
Upper/Lower Split,Thursday,Upper Split,Triceps Pushdown,3,12-15,60,,40
Upper/Lower Split,Friday,Lower Split,Deadlift,3,5,180,,185
Upper/Lower Split,Friday,Lower Split,Leg Press,3,10-12,90,,180
Bodyweight Mastery,Monday,Calisthenics,Pull-ups,4,5-10,120,Use bands if needed,
Bodyweight Mastery,Monday,Calisthenics,Dips,4,8-12,90,Focus on triceps,
Bodyweight Mastery,Monday,Calisthenics,Bodyweight Squats,4,20,60,Fast tempo,
Bodyweight Mastery,Wednesday,Calisthenics,Plank to Pushup,3,10,60,,
Bodyweight Mastery,Wednesday,Calisthenics,Hollow Body Hold,3,30s,60,,
Bodyweight Mastery,Wednesday,Calisthenics,Bird-Dog,3,12,30,Reps per side,
Bodyweight Mastery,Friday,Calisthenics,Chin-ups,4,5-10,120,,
Bodyweight Mastery,Friday,Calisthenics,Diamond Push-ups,4,10-15,90,,
Bodyweight Mastery,Friday,Calisthenics,Bulgarian Split Squats,3,10,60,Reps per leg,
30-Min Express,Any,Express Circuit,Kettlebell Swings,4,20,30,Minimal rest between moves,35
30-Min Express,Any,Express Circuit,Dumbbell Thrusters,4,12,30,Squat into overhead press,20
30-Min Express,Any,Express Circuit,Mountain Climbers,4,40,30,Fast pace,
30-Min Express,Any,Express Circuit,Renegade Rows,4,10,30,Reps per arm,25
30-Min Express,Any,Express Circuit,Burpees,4,10,60,Rest 60s after full round,`;

        // Initialize app
        function init() {
            loadFromStorage();
            loadBuiltInPrograms();
            bindEventHandlers();
            updateStats();
            updatePlanHint();
            if (currentWorkout) {
                showActiveWorkout();
            }
            if (workoutPlan) {
                console.log('Workout plan loaded');
            }
        }

        function bindEventHandlers() {
            document.getElementById('startWorkoutBtn').addEventListener('click', showWorkoutSelect);
            document.getElementById('viewHistoryBtn').addEventListener('click', showHistory);
            document.getElementById('showImportBtn').addEventListener('click', showImport);
            document.getElementById('showProgramsBtn').addEventListener('click', showPrograms);
            document.getElementById('workoutSelectBackBtn').addEventListener('click', showHome);
            document.getElementById('activeWorkoutBackBtn').addEventListener('click', showWorkoutSelect);
            document.getElementById('completeWorkoutBtn').addEventListener('click', completeWorkout);
            document.getElementById('importBackBtn').addEventListener('click', showHome);
            document.getElementById('historyBackBtn').addEventListener('click', showHome);
            document.getElementById('programsBackBtn').addEventListener('click', showHome);
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            document.getElementById('cancelProgramBtn').addEventListener('click', closeProgramModal);
            document.getElementById('confirmProgramBtn').addEventListener('click', confirmProgramLoad);
            document.getElementById('closeExerciseDemoBtn').addEventListener('click', closeExerciseDemo);
            document.getElementById('exerciseDemoModal').addEventListener('click', (event) => {
                if (event.target.id === 'exerciseDemoModal') closeExerciseDemo();
            });

            document.getElementById('exercisesList').addEventListener('click', (event) => {
                ensureAudioContext();
                const demo = event.target.closest('.exercise-demo-btn');
                if (demo) {
                    const exIndex = parseInt(demo.dataset.exIndex, 10);
                    const exercise = currentWorkout.exercises[exIndex];
                    const opened = openExerciseDemo(exercise);
                    if (!opened) {
                        window.open(getYouTubeSearchUrl((exercise && exercise.name) || 'exercise'), '_blank', 'noopener,noreferrer');
                    }
                    recordActivity();
                    return;
                }

                const quick = event.target.closest('.quick-timer-btn');
                if (quick) {
                    const exIndex = parseInt(quick.dataset.exIndex, 10);
                    const seconds = parseInt(quick.dataset.seconds, 10);
                    startTimer(exIndex, seconds);
                    return;
                }

                const toggle = event.target.closest('.timer-toggle-btn');
                if (toggle) {
                    const exIndex = parseInt(toggle.dataset.exIndex, 10);
                    toggleTimer(exIndex);
                    return;
                }

                const reset = event.target.closest('.timer-reset-btn');
                if (reset) {
                    const exIndex = parseInt(reset.dataset.exIndex, 10);
                    resetTimer(exIndex);
                }
            });

            document.getElementById('programsList').addEventListener('click', (event) => {
                const btn = event.target.closest('.program-load-btn');
                if (!btn) return;
                const programName = btn.dataset.program;
                const program = builtInPrograms.find((p) => p.name === programName);
                if (!program) return;
                openProgramModal(program);
            });

            document.addEventListener('touchstart', ensureAudioContext, { passive: true, once: true });
            document.addEventListener('click', ensureAudioContext, { once: true });

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden') {
                    saveCurrentWorkout();
                    return;
                }
                resumeRunningTimers();
            });

            window.addEventListener('pagehide', saveCurrentWorkout);

            ['click', 'touchstart', 'keydown', 'input'].forEach((eventName) => {
                document.addEventListener(eventName, recordActivity, { passive: true });
            });
        }

        // Storage functions
        function saveToStorage() {
            localStorage.setItem('workoutPlan', JSON.stringify(workoutPlan));
            localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));
        }

        function loadFromStorage() {
            const planData = localStorage.getItem('workoutPlan');
            const historyData = localStorage.getItem('workoutHistory');
            
            if (planData) workoutPlan = normalizePlan(JSON.parse(planData));
            if (historyData) workoutHistory = JSON.parse(historyData);
            loadCurrentWorkout();
        }

        function saveCurrentWorkout() {
            if (!currentWorkout) {
                localStorage.removeItem('currentWorkout');
                localStorage.removeItem('timerState');
                return;
            }
            localStorage.setItem('currentWorkout', JSON.stringify(currentWorkout));
            localStorage.setItem('timerState', JSON.stringify({
                seconds: timerSeconds,
                running: timerRunning,
                endAt: timerEndAt
            }));
        }

        function loadCurrentWorkout() {
            const workoutData = localStorage.getItem('currentWorkout');
            if (workoutData) {
                currentWorkout = JSON.parse(workoutData);
            }
            const timerState = localStorage.getItem('timerState');
            if (timerState) {
                try {
                    const parsed = JSON.parse(timerState);
                    timerSeconds = Array.isArray(parsed.seconds) ? parsed.seconds : [];
                    timerRunning = Array.isArray(parsed.running) ? parsed.running : [];
                    timerEndAt = Array.isArray(parsed.endAt) ? parsed.endAt : [];
                } catch (error) {
                    console.warn('Timer state load failed', error);
                }
            }
        }

        function getPlanName() {
            if (!workoutPlan || Object.keys(workoutPlan).length === 0) return null;
            const keys = Object.keys(workoutPlan);
            return keys.length > 0 ? keys[0] : null;
        }

        function updatePlanHint() {
            const hint = document.getElementById('planHint');
            const startBtn = document.getElementById('startWorkoutBtn');
            if (!hint || !startBtn) return;

            if (!workoutPlan || Object.keys(workoutPlan).length === 0) {
                hint.textContent = 'No plan yet? Browse ready-made plans or import a template.';
                startBtn.disabled = true;
                startBtn.classList.add('btn-disabled');
            } else {
                const name = getPlanName();
                hint.textContent = name ? `Current plan: ${name}` : 'Plan loaded.';
                startBtn.disabled = false;
                startBtn.classList.remove('btn-disabled');
            }
        }

        const blockedKeys = new Set(['__proto__', 'prototype', 'constructor']);
        const MAX_FILE_SIZE_BYTES = 10 * 1024 * 1024;
        const MAX_NAME_LENGTH = 60;
        const MAX_NOTES_LENGTH = 200;
        const MAX_WEIGHT_LENGTH = 20;
        const MAX_REPS_LENGTH = 20;
        const MAX_URL_LENGTH = 500;
        const MAX_DEMO_TYPE_LENGTH = 20;
        const MIN_SETS = 1;
        const MAX_SETS = 20;
        const MIN_REST = 0;
        const MAX_REST = 600;
        const DEFAULT_DEMO_TYPE = 'youtube';
        const DEMO_QUERY_OVERRIDES = {
            'barbell squat': 'barbell back squat proper form',
            'back squat': 'barbell back squat proper form',
            'bench press': 'barbell bench press proper form',
            'barbell bench press': 'barbell bench press proper form',
            'overhead press': 'barbell overhead press proper form',
            'shoulder press': 'dumbbell shoulder press proper form',
            'barbell row': 'barbell bent over row proper form',
            'dumbbell row': 'one arm dumbbell row proper form',
            'dumbbell rows': 'one arm dumbbell row proper form',
            'deadlift': 'conventional deadlift proper form',
            'romanian deadlift': 'romanian deadlift proper form',
            'leg press': 'leg press proper form',
            'pull ups': 'strict pull up proper form',
            'pull-ups': 'strict pull up proper form',
            'chin ups': 'chin up proper form',
            'chin-ups': 'chin up proper form',
            'push ups': 'push up proper form',
            'push-ups': 'push up proper form',
            'dips': 'parallel bar dips proper form',
            'lat pulldowns': 'lat pulldown proper form',
            'triceps pushdown': 'triceps cable pushdown proper form',
            'bulgarian split squats': 'bulgarian split squat proper form',
            'goblet squats': 'goblet squat proper form',
            'kettlebell swings': 'kettlebell swing proper form',
            'mountain climbers': 'mountain climber exercise form',
            'burpees': 'burpee proper form'
        };

        function clampNumber(value, min, max, fallback) {
            const parsed = Number.parseInt(value, 10);
            if (Number.isNaN(parsed)) return fallback;
            return Math.min(max, Math.max(min, parsed));
        }

        function normalizeText(value, maxLength) {
            if (value == null) return '';
            return String(value).trim().slice(0, maxLength);
        }

        function normalizeExerciseKey(name) {
            return normalizeText(name, MAX_NAME_LENGTH)
                .toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function getDemoSearchQuery(exerciseName) {
            const key = normalizeExerciseKey(exerciseName);
            return DEMO_QUERY_OVERRIDES[key] || `${normalizeText(exerciseName, MAX_NAME_LENGTH)} exercise form`;
        }

        function getYouTubeSearchUrl(exerciseName) {
            const query = encodeURIComponent(getDemoSearchQuery(exerciseName));
            return `https://www.youtube.com/results?search_query=${query}`;
        }

        function resolveDemoFields(exerciseName, rawType, rawUrl, rawPoster) {
            const demoPoster = normalizeText(rawPoster, MAX_URL_LENGTH);
            const explicitType = normalizeText(rawType, MAX_DEMO_TYPE_LENGTH).toLowerCase();
            const explicitUrl = normalizeText(rawUrl, MAX_URL_LENGTH);

            if (explicitUrl) {
                const detectedType = inferDemoType(explicitType, explicitUrl);
                const normalizedUrl = normalizeDemoUrl(detectedType || explicitType, explicitUrl, exerciseName);
                return {
                    demoType: detectedType || explicitType || 'link',
                    demoUrl: normalizedUrl,
                    demoPoster
                };
            }

            return {
                demoType: DEFAULT_DEMO_TYPE,
                demoUrl: getYouTubeSearchUrl(exerciseName),
                demoPoster: ''
            };
        }

        function normalizePlan(rawPlan) {
            const safePlan = Object.create(null);
            if (!rawPlan || typeof rawPlan !== 'object') return safePlan;

            Object.keys(rawPlan).forEach((key) => {
                if (blockedKeys.has(key)) return;
                const exercises = Array.isArray(rawPlan[key]) ? rawPlan[key] : [];
                safePlan[key] = exercises.map((ex) => {
                    const name = normalizeText(ex && ex.name, MAX_NAME_LENGTH);
                    const resolvedDemo = resolveDemoFields(
                        name,
                        ex && ex.demoType,
                        ex && ex.demoUrl,
                        ex && ex.demoPoster
                    );

                    return {
                    name,
                    sets: clampNumber(ex && ex.sets, MIN_SETS, MAX_SETS, 3),
                    reps: normalizeText(ex && ex.reps, MAX_REPS_LENGTH) || '10-12',
                    rest: clampNumber(ex && ex.rest, MIN_REST, MAX_REST, 60),
                    notes: normalizeText(ex && ex.notes, MAX_NOTES_LENGTH),
                    suggestedWeight: normalizeText(ex && ex.suggestedWeight, MAX_WEIGHT_LENGTH),
                    demoType: resolvedDemo.demoType,
                    demoUrl: resolvedDemo.demoUrl,
                    demoPoster: resolvedDemo.demoPoster
                };
                });
            });

            return safePlan;
        }

        // File upload handler
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > MAX_FILE_SIZE_BYTES) {
                alert('File is too large. Please select a file under 10MB.');
                event.target.value = '';
                return;
            }
            const isCsv = file.name.toLowerCase().endsWith('.csv');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = isCsv
                        ? XLSX.read(e.target.result, {type: 'string'})
                        : XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                    parseWorkoutPlan(workbook);
                    alert('Workout plan imported successfully!');
                    showHome();
                } catch (error) {
                    alert('Error reading file. Please check the format.');
                    console.error(error);
                }
            };
            if (isCsv) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        function parseWorkoutPlan(workbook) {
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});
            
            workoutPlan = Object.create(null);
            let currentDay = null;

            const headerRow = rows.find((row) => Array.isArray(row) && row.some(cell => cell != null && cell !== ''));
            const headerMap = getHeaderMap(headerRow || []);

            if (headerMap.day !== -1 || headerMap.type !== -1 || headerMap.exercise !== -1) {
                if (headerMap.day === -1 || headerMap.exercise === -1) {
                    alert('Missing required headers. Please include Day and Exercise columns.');
                    return;
                }
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (!row || row.length === 0) continue;

                    const dayValue = normalizeText(row[headerMap.day], MAX_NAME_LENGTH);
                    const typeValue = normalizeText(row[headerMap.type], MAX_NAME_LENGTH);
                    const exerciseValue = normalizeText(row[headerMap.exercise], MAX_NAME_LENGTH);

                    if (dayValue || typeValue) {
                        const title = `${dayValue}${typeValue ? ` (${typeValue})` : ''}`.trim();
                        if (title && !blockedKeys.has(title)) {
                            if (!workoutPlan[title]) workoutPlan[title] = [];
                            currentDay = title;
                        } else {
                            currentDay = null;
                        }
                    }

                    if (currentDay && exerciseValue) {
                        const resolvedDemo = resolveDemoFields(
                            exerciseValue,
                            row[headerMap.demoType],
                            row[headerMap.demoUrl],
                            row[headerMap.demoPoster]
                        );

                        workoutPlan[currentDay].push({
                            name: exerciseValue,
                            sets: clampNumber(row[headerMap.sets], MIN_SETS, MAX_SETS, 3),
                            reps: normalizeText(row[headerMap.reps], MAX_REPS_LENGTH) || '10-12',
                            rest: clampNumber(row[headerMap.rest], MIN_REST, MAX_REST, 60),
                            notes: normalizeText(row[headerMap.notes], MAX_NOTES_LENGTH),
                            suggestedWeight: normalizeText(row[headerMap.suggestedWeight], MAX_WEIGHT_LENGTH),
                            demoType: resolvedDemo.demoType,
                            demoUrl: resolvedDemo.demoUrl,
                            demoPoster: resolvedDemo.demoPoster
                        });
                    }
                }
            } else {
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (!row || row.length === 0) continue;
                    const colA = row[0];
                    const colB = row[1];
                    const isHeaderRow =
                        colA &&
                        colA.toString().includes('(') &&
                        !colA.toString().trim().startsWith('-') &&
                        (colB == null || colB.toString().trim() === '');

                    if (isHeaderRow) {
                        currentDay = normalizeText(colA, MAX_NAME_LENGTH);
                        if (blockedKeys.has(currentDay)) {
                            currentDay = null;
                            continue;
                        }
                        workoutPlan[currentDay] = [];
                    } else if (currentDay && colB) {
                        const fallbackExerciseName = normalizeText(colB, MAX_NAME_LENGTH);
                        const resolvedDemo = resolveDemoFields(fallbackExerciseName, '', '', '');
                        workoutPlan[currentDay].push({
                            name: fallbackExerciseName,
                            sets: clampNumber(row[2], MIN_SETS, MAX_SETS, 3),
                            reps: normalizeText(row[3], MAX_REPS_LENGTH) || '10-12',
                            rest: clampNumber(row[4], MIN_REST, MAX_REST, 60),
                            notes: normalizeText(row[5], MAX_NOTES_LENGTH),
                            suggestedWeight: normalizeText(row[6], MAX_WEIGHT_LENGTH),
                            demoType: resolvedDemo.demoType,
                            demoUrl: resolvedDemo.demoUrl,
                            demoPoster: resolvedDemo.demoPoster
                        });
                    }
                }
            }
            
            saveToStorage();
            updatePlanHint();
        }

        function getHeaderMap(headerRow) {
            const indexOf = (value) => headerRow.findIndex((cell) => {
                if (cell == null) return false;
                return cell.toString().trim().toLowerCase() === value;
            });

            const indexOfAny = (values) => headerRow.findIndex((cell) => {
                if (cell == null) return false;
                const normalized = cell.toString().trim().toLowerCase();
                return values.includes(normalized);
            });

            return {
                day: indexOfAny(['day']),
                type: indexOfAny(['type']),
                exercise: indexOfAny(['exercise']),
                sets: indexOfAny(['sets', 'set']),
                reps: indexOfAny(['reps', 'rep']),
                rest: indexOfAny(['rest', 'rest (sec)', 'rest seconds']),
                notes: indexOfAny(['notes', 'note']),
                suggestedWeight: indexOfAny(['suggested weight', 'suggested', 'weight']),
                demoType: indexOfAny(['demo type', 'media type', 'visual type']),
                demoUrl: indexOfAny(['demo url', 'media url', 'visual url', 'video url', 'image url']),
                demoPoster: indexOfAny(['demo poster', 'poster url', 'thumbnail url', 'thumbnail'])
            };
        }

        function playTimerBeep() {
            try {
                const ctx = ensureAudioContext();
                if (!ctx) return;
                const now = ctx.currentTime;
                const beepDuration = 0.12;
                const gap = 0.08;
                const baseFrequency = 880;

                for (let i = 0; i < 3; i++) {
                    const startTime = now + i * (beepDuration + gap);
                    const oscillator = ctx.createOscillator();
                    const gain = ctx.createGain();
                    oscillator.type = 'sine';
                    oscillator.frequency.value = baseFrequency;
                    gain.gain.setValueAtTime(0.0001, startTime);
                    gain.gain.linearRampToValueAtTime(0.2, startTime + 0.02);
                    gain.gain.exponentialRampToValueAtTime(0.0001, startTime + beepDuration);
                    oscillator.connect(gain);
                    gain.connect(ctx.destination);
                    oscillator.start(startTime);
                    oscillator.stop(startTime + beepDuration);
                }
            } catch (error) {
                console.warn('Timer beep failed', error);
            }
        }

        // Navigation
        function showHome() {
            hideAllScreens();
            document.getElementById('homeScreen').classList.remove('hidden');
            updateStats();
            updatePlanHint();
        }

        function showWorkoutSelect() {
            if (!workoutPlan || Object.keys(workoutPlan).length === 0) {
                alert('Please import a workout plan first');
                showImport();
                return;
            }
            hideAllScreens();
            document.getElementById('workoutSelectScreen').classList.remove('hidden');
            renderWorkoutDays();
        }

        function showImport() {
            hideAllScreens();
            document.getElementById('importScreen').classList.remove('hidden');
        }

        function showHistory() {
            hideAllScreens();
            document.getElementById('historyScreen').classList.remove('hidden');
            renderHistory();
        }

        function showPrograms() {
            hideAllScreens();
            document.getElementById('programsScreen').classList.remove('hidden');
            renderPrograms();
        }

        function hideAllScreens() {
            document.querySelectorAll('#homeScreen, #workoutSelectScreen, #activeWorkoutScreen, #importScreen, #historyScreen, #programsScreen')
                .forEach(screen => screen.classList.add('hidden'));
            closeExerciseDemo();
        }

        async function loadBuiltInPrograms() {
            builtInPrograms = parseProgramsCsv(PROGRAMS_CSV);
            if (document.getElementById('programsScreen') && !document.getElementById('programsScreen').classList.contains('hidden')) {
                renderPrograms();
            }
        }

        function parseProgramsCsv(csvText) {
            const workbook = XLSX.read(csvText, {type: 'string'});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});
            const header = rows[0] || [];
            const map = getHeaderMap(header);
            const programIndex = header.findIndex((cell) => cell && cell.toString().trim().toLowerCase() === 'program');
            if (programIndex === -1 || map.day === -1 || map.exercise === -1) return [];

            const programMap = Object.create(null);
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || row.length === 0) continue;
                const programName = normalizeText(row[programIndex], MAX_NAME_LENGTH);
                if (!programName) continue;
                const dayValue = normalizeText(row[map.day], MAX_NAME_LENGTH);
                const typeValue = normalizeText(row[map.type], MAX_NAME_LENGTH);
                const exerciseValue = normalizeText(row[map.exercise], MAX_NAME_LENGTH);
                if (!exerciseValue) continue;

                if (!programMap[programName]) {
                    programMap[programName] = Object.create(null);
                }

                const title = `${dayValue}${typeValue ? ` (${typeValue})` : ''}`.trim();
                if (!title || blockedKeys.has(title)) continue;

                if (!programMap[programName][title]) {
                    programMap[programName][title] = [];
                }

                const resolvedDemo = resolveDemoFields(
                    exerciseValue,
                    row[map.demoType],
                    row[map.demoUrl],
                    row[map.demoPoster]
                );

                programMap[programName][title].push({
                    name: exerciseValue,
                    sets: clampNumber(row[map.sets], MIN_SETS, MAX_SETS, 3),
                    reps: normalizeText(row[map.reps], MAX_REPS_LENGTH) || '10-12',
                    rest: clampNumber(row[map.rest], MIN_REST, MAX_REST, 60),
                    notes: normalizeText(row[map.notes], MAX_NOTES_LENGTH),
                    suggestedWeight: normalizeText(row[map.suggestedWeight], MAX_WEIGHT_LENGTH),
                    demoType: resolvedDemo.demoType,
                    demoUrl: resolvedDemo.demoUrl,
                    demoPoster: resolvedDemo.demoPoster
                });
            }

            const descriptions = {
                'StrongLifts 5x5': 'This program focuses on building pure strength through five fundamental compound barbell lifts performed for five sets of five reps. It utilizes a simple alternating \"A/B\" schedule that prioritizes consistent, heavy weight progression over time.',
                '3-Day Full Body': 'Designed for overall fitness, this routine hits every major muscle group in a single session to maximize efficiency for beginners. It provides a balanced approach to strength and conditioning without requiring more than three days in the gym per week.',
                'Upper/Lower Split': 'This intermediate routine divides the body into two distinct types of sessions, allowing for a higher volume of work on specific muscle groups. By alternating between upper and lower body days, users can increase their training frequency and recovery potential.',
                'Bodyweight Mastery': 'Focused entirely on calisthenics, this routine uses your own weight and gravity to develop functional strength, balance, and mobility. It is the ideal choice for users who prefer to work out at home or outdoors with little to no equipment.',
                '30-Min Express': 'This fast-paced circuit is built for busy schedules, using high-intensity movements to improve cardiovascular health while toning muscle. It minimizes rest periods to keep the heart rate elevated, ensuring a complete workout in a short window of time.'
            };

            return Object.keys(programMap).map((name) => ({
                name,
                description: descriptions[name] || 'A complete training routine ready to load.',
                plan: programMap[name]
            }));
        }

        function renderPrograms() {
            const list = document.getElementById('programsList');
            list.innerHTML = '';

            if (builtInPrograms.length === 0) {
                const empty = document.createElement('div');
                empty.style.color = 'var(--text-secondary)';
                empty.style.textAlign = 'center';
                empty.style.padding = '20px';
                empty.textContent = 'Programs are unavailable right now.';
                list.appendChild(empty);
                return;
            }

            builtInPrograms.forEach((program) => {
                const card = document.createElement('div');
                card.className = 'exercise-card';

                const title = document.createElement('div');
                title.className = 'program-title';
                title.textContent = program.name;

                const desc = document.createElement('div');
                desc.className = 'program-desc';
                desc.textContent = program.description;

                const action = document.createElement('button');
                action.className = 'btn btn-secondary program-load-btn';
                action.dataset.program = program.name;
                action.textContent = 'Load Program';

                card.append(title, desc, action);
                list.appendChild(card);
            });
        }

        function openProgramModal(program) {
            selectedProgram = program;
            document.getElementById('programModalTitle').textContent = program.name;
            document.getElementById('programModalBody').textContent =
                'This will replace your current workout plan. You can re-import anytime.';
            document.getElementById('programModal').classList.remove('hidden');
        }

        function closeProgramModal() {
            selectedProgram = null;
            document.getElementById('programModal').classList.add('hidden');
        }

        function confirmProgramLoad() {
            if (!selectedProgram) return;
            workoutPlan = normalizePlan(selectedProgram.plan);
            saveToStorage();
            closeProgramModal();
            updatePlanHint();
            showWorkoutSelect();
        }

        // Render workout days
        function renderWorkoutDays() {
            const list = document.getElementById('workoutDaysList');
            list.innerHTML = '';
            
            for (const [day, exercises] of Object.entries(workoutPlan)) {
                const btn = document.createElement('button');
                btn.className = 'btn workout-day-btn';
                const title = document.createElement('div');
                title.className = 'workout-day-title';
                title.textContent = day;
                const info = document.createElement('div');
                info.className = 'workout-day-info';
                info.textContent = `${exercises.length} exercises`;
                btn.append(title, info);
                btn.addEventListener('click', () => startWorkout(day));
                list.appendChild(btn);
            }
        }

        // Start workout
        function startWorkout(dayName) {
            currentWorkout = {
                day: dayName,
                date: new Date().toISOString(),
                exercises: workoutPlan[dayName].map(ex => ({
                    ...ex,
                    sets: Array(parseInt(ex.sets)).fill(null).map(() => ({weight: '', reps: ''}))
                }))
            };
            ensureTimerState(currentWorkout.exercises.length);
            saveCurrentWorkout();
            hideAllScreens();
            document.getElementById('activeWorkoutScreen').classList.remove('hidden');
            document.getElementById('currentWorkoutTitle').textContent = dayName;
            renderExercises();
            recordActivity();
        }

        function showActiveWorkout() {
            if (!currentWorkout) return;
            ensureTimerState(currentWorkout.exercises.length);
            hideAllScreens();
            document.getElementById('activeWorkoutScreen').classList.remove('hidden');
            document.getElementById('currentWorkoutTitle').textContent = currentWorkout.day || '';
            renderExercises();
            recordActivity();
        }

        // Render exercises
        function renderExercises() {
            const list = document.getElementById('exercisesList');
            list.innerHTML = '';
            ensureTimerState(currentWorkout.exercises.length);
            
            currentWorkout.exercises.forEach((exercise, exIndex) => {
                const card = document.createElement('div');
                card.className = 'exercise-card';
                
                const lastWeight = getLastWeight(exercise.name);

                const header = document.createElement('div');
                header.className = 'exercise-header';

                const name = document.createElement('div');
                name.className = 'exercise-name';
                name.textContent = exercise.name;

                const meta = document.createElement('div');
                meta.className = 'exercise-meta';
                const metaLine1 = document.createElement('div');
                metaLine1.textContent = `${exercise.sets.length} √ó ${exercise.reps}`;
                const metaLine2 = document.createElement('div');
                metaLine2.textContent = `Rest: ${exercise.rest}s`;
                meta.append(metaLine1, metaLine2);

                header.append(name, meta);
                card.appendChild(header);

                if (lastWeight) {
                    const last = document.createElement('div');
                    last.className = 'last-weight';
                    last.textContent = `Last: ${lastWeight}`;
                    card.appendChild(last);
                } else if (exercise.suggestedWeight) {
                    const suggested = document.createElement('div');
                    suggested.className = 'last-weight';
                    suggested.textContent = `Suggested: ${exercise.suggestedWeight}`;
                    card.appendChild(suggested);
                }

                const demoBtn = document.createElement('button');
                demoBtn.className = 'btn btn-secondary exercise-demo-btn';
                demoBtn.dataset.exIndex = String(exIndex);
                demoBtn.textContent = 'How to Do It';
                card.appendChild(demoBtn);

                for (let setNum = 0; setNum < exercise.sets.length; setNum++) {
                    const setData = exercise.sets[setNum];
                    const group = document.createElement('div');
                    group.className = 'set-input-group';

                    const label = document.createElement('div');
                    label.className = 'set-label';
                    label.textContent = `Set ${setNum + 1}`;

                    const wrapper = document.createElement('div');
                    wrapper.className = 'weight-input-wrapper';

                    const weightInput = document.createElement('input');
                    weightInput.type = 'number';
                    weightInput.className = 'weight-input';
                    weightInput.placeholder = 'Weight (lbs)';
                    weightInput.value = setData.weight;
                    weightInput.addEventListener('input', (event) => {
                        updateSet(exIndex, setNum, 'weight', event.target.value);
                    });

                    const repsInput = document.createElement('input');
                    repsInput.type = 'number';
                    repsInput.className = 'weight-input';
                    repsInput.placeholder = 'Reps';
                    repsInput.value = setData.reps;
                    repsInput.addEventListener('input', (event) => {
                        updateSet(exIndex, setNum, 'reps', event.target.value);
                    });

                    wrapper.append(weightInput, repsInput);
                    group.append(label, wrapper);
                    card.appendChild(group);
                }

                const timerSection = document.createElement('div');
                timerSection.className = 'timer timer-mini';

                const display = document.createElement('div');
                display.className = 'timer-display';
                display.dataset.exIndex = String(exIndex);
                display.textContent = formatTime(timerSeconds[exIndex] || 0);

                const quickBtns = document.createElement('div');
                quickBtns.className = 'quick-timer-btns';

                const quickOptions = [
                    { seconds: 60, label: '60s' },
                    { seconds: 90, label: '90s' },
                    { seconds: 120, label: '2min' }
                ];

                quickOptions.forEach((option) => {
                    const btn = document.createElement('button');
                    btn.className = 'btn quick-timer-btn';
                    btn.dataset.exIndex = String(exIndex);
                    btn.dataset.seconds = String(option.seconds);
                    btn.textContent = option.label;
                    quickBtns.appendChild(btn);
                });

                const controls = document.createElement('div');
                controls.className = 'timer-controls';

                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'btn btn-secondary timer-toggle-btn';
                toggleBtn.dataset.exIndex = String(exIndex);
                toggleBtn.textContent = 'Start';

                const resetBtn = document.createElement('button');
                resetBtn.className = 'btn btn-secondary timer-reset-btn';
                resetBtn.dataset.exIndex = String(exIndex);
                resetBtn.textContent = 'Reset';

                controls.append(toggleBtn, resetBtn);
                timerSection.append(display, quickBtns, controls);
                card.appendChild(timerSection);
                
                list.appendChild(card);
            });
            resumeRunningTimers();
        }

        function openExerciseDemo(exercise) {
            if (!exercise) return false;
            selectedExerciseDemo = exercise;
            const modal = document.getElementById('exerciseDemoModal');
            const title = document.getElementById('exerciseDemoTitle');
            const body = document.getElementById('exerciseDemoBody');
            const sourceLink = document.getElementById('exerciseDemoSourceLink');
            if (!modal || !title || !body || !sourceLink) return false;

            title.textContent = exercise.name ? `${exercise.name} Demo` : 'Exercise Demo';
            body.innerHTML = '';

            const resolvedDemo = resolveDemoFields(
                exercise.name || 'exercise',
                exercise.demoType,
                exercise.demoUrl,
                exercise.demoPoster
            );
            const demoType = resolvedDemo.demoType;
            const demoUrl = resolvedDemo.demoUrl;
            const demoPoster = resolvedDemo.demoPoster;

            sourceLink.classList.add('hidden');
            sourceLink.removeAttribute('href');
            sourceLink.textContent = 'Open Source';

            if (!demoUrl) {
                const fallbackMessage = document.createElement('div');
                fallbackMessage.textContent = 'No demo is attached to this exercise yet.';
                body.appendChild(fallbackMessage);
                sourceLink.href = getYouTubeSearchUrl(exercise.name || 'exercise');
                sourceLink.textContent = 'Search YouTube';
                sourceLink.classList.remove('hidden');
            } else if (demoType === 'youtube' || isYouTubeUrl(demoUrl)) {
                const linkMessage = document.createElement('div');
                linkMessage.textContent = 'Open the demo on YouTube. This avoids embedded playback errors on some devices.';
                body.appendChild(linkMessage);
                sourceLink.href = demoUrl;
                sourceLink.textContent = 'Open on YouTube';
                sourceLink.classList.remove('hidden');
            } else if (demoType === 'video') {
                const mediaWrap = document.createElement('div');
                mediaWrap.className = 'demo-media-wrap';
                const video = document.createElement('video');
                video.className = 'demo-media';
                video.controls = true;
                video.playsInline = true;
                video.preload = 'metadata';
                if (demoPoster) video.poster = demoPoster;
                video.src = demoUrl;
                mediaWrap.appendChild(video);
                body.appendChild(mediaWrap);

                sourceLink.href = demoUrl;
                sourceLink.classList.remove('hidden');
            } else if (demoType === 'image' || demoType === 'gif') {
                const mediaWrap = document.createElement('div');
                mediaWrap.className = 'demo-media-wrap';
                const image = document.createElement('img');
                image.className = 'demo-media';
                image.src = demoUrl;
                image.alt = `${exercise.name || 'Exercise'} demo`;
                mediaWrap.appendChild(image);
                body.appendChild(mediaWrap);

                sourceLink.href = demoUrl;
                sourceLink.classList.remove('hidden');
            } else {
                const linkMessage = document.createElement('div');
                linkMessage.textContent = 'Open the exercise demo in a new tab.';
                body.appendChild(linkMessage);
                sourceLink.href = demoUrl;
                sourceLink.classList.remove('hidden');
            }

            modal.classList.remove('hidden');
            return true;
        }

        function closeExerciseDemo() {
            const modal = document.getElementById('exerciseDemoModal');
            const body = document.getElementById('exerciseDemoBody');
            if (!modal || !body) return;
            modal.classList.add('hidden');
            body.innerHTML = '';
            selectedExerciseDemo = null;
        }

        function inferDemoType(rawType, url) {
            const normalizedType = normalizeText(rawType, MAX_DEMO_TYPE_LENGTH).toLowerCase();
            if (['youtube', 'video', 'image', 'gif', 'link'].includes(normalizedType)) return normalizedType;

            const normalizedUrl = (url || '').toLowerCase().split('?')[0];
            if (isYouTubeUrl(url || '')) return 'youtube';
            if (/\.(mp4|webm|mov|m4v)$/.test(normalizedUrl)) return 'video';
            if (/\.(gif)$/.test(normalizedUrl)) return 'gif';
            if (/\.(png|jpe?g|webp|avif|svg)$/.test(normalizedUrl)) return 'image';
            return normalizedUrl ? 'link' : '';
        }

        function isYouTubeUrl(url) {
            const normalized = (url || '').toLowerCase();
            return normalized.includes('youtube.com') || normalized.includes('youtu.be');
        }

        function normalizeDemoUrl(demoType, url, exerciseName) {
            const cleanType = (demoType || '').toLowerCase();
            if (cleanType !== 'youtube' && !isYouTubeUrl(url)) return url;

            try {
                const parsed = new URL(url, window.location.origin);
                const host = parsed.hostname.toLowerCase();
                const path = parsed.pathname;

                if (host.includes('youtube.com')) {
                    if (path.startsWith('/watch')) {
                        const videoId = parsed.searchParams.get('v');
                        if (videoId) return `https://www.youtube.com/watch?v=${videoId}`;
                    }

                    if (path.startsWith('/embed/')) {
                        const videoId = path.split('/')[2];
                        if (videoId) return `https://www.youtube.com/watch?v=${videoId}`;

                        const listType = parsed.searchParams.get('listType');
                        const list = parsed.searchParams.get('list');
                        if (listType === 'search' && list) {
                            return `https://www.youtube.com/results?search_query=${encodeURIComponent(list)}`;
                        }
                    }

                    if (path === '/results') {
                        const query = parsed.searchParams.get('search_query');
                        if (query) return `https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`;
                    }
                }

                if (host.includes('youtu.be')) {
                    const videoId = path.replace('/', '').split('/')[0];
                    if (videoId) return `https://www.youtube.com/watch?v=${videoId}`;
                }
            } catch (error) {
                console.warn('Could not normalize demo URL', error);
            }

            return getYouTubeSearchUrl(exerciseName);
        }

        function ensureTimerState(count) {
            if (!Array.isArray(timerIntervals) || timerIntervals.length !== count) {
                timerIntervals = new Array(count).fill(null);
            }
            if (!Array.isArray(timerSeconds) || timerSeconds.length !== count) {
                timerSeconds = new Array(count).fill(0);
            }
            if (!Array.isArray(timerRunning) || timerRunning.length !== count) {
                timerRunning = new Array(count).fill(false);
            }
            if (!Array.isArray(timerEndAt) || timerEndAt.length !== count) {
                timerEndAt = new Array(count).fill(null);
            }
        }

        function updateSet(exIndex, setNum, field, value) {
            currentWorkout.exercises[exIndex].sets[setNum][field] = value;
            saveCurrentWorkout();
        }

        function getLastWeight(exerciseName) {
            for (let i = workoutHistory.length - 1; i >= 0; i--) {
                const workout = workoutHistory[i];
                const exercise = workout.exercises.find(ex => ex.name === exerciseName);
                if (exercise && exercise.sets && exercise.sets.length > 0) {
                    const completedSets = exercise.sets.filter(s => s.weight);
                    if (completedSets.length > 0) {
                        const weights = completedSets.map(s => `${s.weight}lbs √ó ${s.reps}`);
                        return weights.join(', ');
                    }
                }
            }
            return null;
        }

        // Complete workout
        function completeWorkout() {
            if (!currentWorkout) return;
            
            workoutHistory.push({...currentWorkout, completedAt: new Date().toISOString()});
            saveToStorage();
            currentWorkout = null;
            saveCurrentWorkout();
            clearInactivityTimer();
            
            alert('Workout completed! Great work! üí™');
            showHome();
        }

        // Timer functions
        function startTimer(exIndex, seconds) {
            timerSeconds[exIndex] = seconds;
            timerEndAt[exIndex] = Date.now() + seconds * 1000;
            updateTimerDisplay(exIndex);
            if (!timerRunning[exIndex]) {
                toggleTimer(exIndex);
            }
            saveCurrentWorkout();
        }

        function toggleTimer(exIndex) {
            const toggleBtn = document.querySelector(`.timer-toggle-btn[data-ex-index="${exIndex}"]`);
            if (timerRunning[exIndex]) {
                clearTimerInterval(exIndex);
                const remaining = getRemainingSeconds(exIndex);
                timerSeconds[exIndex] = remaining;
                timerEndAt[exIndex] = null;
                timerRunning[exIndex] = false;
                if (toggleBtn) toggleBtn.textContent = 'Start';
            } else {
                if (!timerEndAt[exIndex]) {
                    timerEndAt[exIndex] = Date.now() + (timerSeconds[exIndex] || 0) * 1000;
                }
                startTimerInterval(exIndex);
                timerRunning[exIndex] = true;
                if (toggleBtn) toggleBtn.textContent = 'Pause';
            }
            saveCurrentWorkout();
        }

        function resetTimer(exIndex) {
            clearTimerInterval(exIndex);
            timerRunning[exIndex] = false;
            timerSeconds[exIndex] = 0;
            timerEndAt[exIndex] = null;
            updateTimerDisplay(exIndex);
            const toggleBtn = document.querySelector(`.timer-toggle-btn[data-ex-index="${exIndex}"]`);
            if (toggleBtn) toggleBtn.textContent = 'Start';
            saveCurrentWorkout();
        }

        function updateTimerDisplay(exIndex) {
            const display = document.querySelector(`.timer-display[data-ex-index="${exIndex}"]`);
            if (!display) return;
            display.textContent = formatTime(timerSeconds[exIndex] || 0);
        }

        function formatTime(totalSeconds) {
            const mins = Math.floor(totalSeconds / 60);
            const secs = totalSeconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function getRemainingSeconds(exIndex) {
            if (!timerEndAt[exIndex]) return timerSeconds[exIndex] || 0;
            const remainingMs = timerEndAt[exIndex] - Date.now();
            return Math.max(0, Math.ceil(remainingMs / 1000));
        }

        function startTimerInterval(exIndex) {
            clearTimerInterval(exIndex);
            timerIntervals[exIndex] = setInterval(() => tickTimer(exIndex), 250);
            tickTimer(exIndex);
        }

        function clearTimerInterval(exIndex) {
            clearInterval(timerIntervals[exIndex]);
            timerIntervals[exIndex] = null;
        }

        function tickTimer(exIndex) {
            if (!timerEndAt[exIndex]) {
                updateTimerDisplay(exIndex);
                return;
            }
            const remaining = getRemainingSeconds(exIndex);
            timerSeconds[exIndex] = remaining;
            updateTimerDisplay(exIndex);
            if (remaining <= 0) {
                resetTimer(exIndex);
                playTimerBeep();
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100, 50, 100]);
                }
            }
        }

        function resumeRunningTimers() {
            if (!currentWorkout) return;
            timerRunning.forEach((running, exIndex) => {
                if (running && timerEndAt[exIndex]) {
                    startTimerInterval(exIndex);
                } else {
                    updateTimerDisplay(exIndex);
                }
            });
        }

        function ensureAudioContext() {
            const AudioCtx = window.AudioContext || window.webkitAudioContext;
            if (!AudioCtx) return null;
            if (!audioContext) {
                audioContext = new AudioCtx();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume().catch(() => {});
            }
            return audioContext;
        }

        function recordActivity() {
            if (!currentWorkout) {
                clearInactivityTimer();
                return;
            }
            clearInactivityTimer();
            inactivityTimeout = setTimeout(() => {
                autoCompleteWorkout();
            }, INACTIVITY_COMPLETE_MS);
        }

        function clearInactivityTimer() {
            if (inactivityTimeout) {
                clearTimeout(inactivityTimeout);
                inactivityTimeout = null;
            }
        }

        function autoCompleteWorkout() {
            if (!currentWorkout) return;
            workoutHistory.push({...currentWorkout, completedAt: new Date().toISOString(), autoCompleted: true});
            saveToStorage();
            currentWorkout = null;
            saveCurrentWorkout();
            clearInactivityTimer();
            showHome();
            showToast('Workout auto-completed after 25 minutes of inactivity.');
        }

        function showToast(message, durationMs = 3500) {
            const toast = document.getElementById('toast');
            if (!toast) return;
            toast.textContent = message;
            toast.classList.remove('hidden');
            toast.classList.add('toast-visible');
            clearTimeout(toast._timeoutId);
            toast._timeoutId = setTimeout(() => {
                toast.classList.remove('toast-visible');
                setTimeout(() => toast.classList.add('hidden'), 200);
            }, durationMs);
        }

        // Stats
        function updateStats() {
            const total = workoutHistory.length;
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const thisWeek = workoutHistory.filter(w => new Date(w.completedAt || w.date) > weekAgo).length;
            const monthAgo = new Date();
            monthAgo.setDate(monthAgo.getDate() - 30);
            const thisMonth = workoutHistory.filter(w => new Date(w.completedAt || w.date) > monthAgo).length;
            
            document.getElementById('totalWorkouts').textContent = total;
            document.getElementById('thisWeek').textContent = thisWeek;
            document.getElementById('thisMonth').textContent = thisMonth;
        }

        // Render history
        function renderHistory() {
            const list = document.getElementById('historyList');
            
            if (workoutHistory.length === 0) {
                list.innerHTML = '';
                const empty = document.createElement('div');
                empty.style.textAlign = 'center';
                empty.style.color = 'var(--text-secondary)';
                empty.style.padding = '20px';
                empty.textContent = 'No workouts yet. Get started!';
                list.appendChild(empty);
                return;
            }
            
            list.innerHTML = '';
            
            const sorted = [...workoutHistory].reverse();
            sorted.forEach((workout, index) => {
                const dateValue = workout.completedAt || workout.date;
                const date = new Date(dateValue);
                const card = document.createElement('div');
                card.className = 'exercise-card';

                const header = document.createElement('div');
                header.className = 'exercise-header';

                const name = document.createElement('div');
                name.className = 'exercise-name';
                name.textContent = workout.day;

                const meta = document.createElement('div');
                meta.className = 'exercise-meta';
                meta.textContent = `${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}`;

                header.append(name, meta);

                const summary = document.createElement('div');
                summary.style.fontSize = '0.85rem';
                summary.style.color = 'var(--text-secondary)';
                summary.textContent = `${workout.exercises.length} exercises completed`;

                card.append(header, summary);

                workout.exercises.forEach((exercise) => {
                    const row = document.createElement('div');
                    row.style.fontSize = '0.85rem';
                    row.style.color = 'var(--text-secondary)';
                    row.style.marginTop = '6px';

                    const total = calculateTotalWeight(exercise.sets);
                    row.textContent = `${exercise.name}: ${total} total`;
                    card.appendChild(row);
                });
                list.appendChild(card);
            });
        }

        function calculateTotalWeight(sets) {
            if (!Array.isArray(sets)) return '0 lbs';
            const total = sets.reduce((sum, set) => {
                const weight = Number.parseFloat(set.weight);
                const reps = Number.parseInt(set.reps, 10);
                if (Number.isNaN(weight) || Number.isNaN(reps)) return sum;
                return sum + (weight * reps);
            }, 0);
            return `${Math.round(total)} lbs`;
        }


        // Initialize on load
        init();
    </script>
</body>
</html>
